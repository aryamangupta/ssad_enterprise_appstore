USE appstore;

CREATE TABLE tbl_profileref
(
    `key` VARCHAR(10) NOT NULL,
    `profile` VARCHAR(100) NOT NULL,
     PRIMARY KEY(`key`)
)ENGINE=InnoDB DEFAULT CHARSET=utf8;	

CREATE TABLE `tbl_user`
(
    `user_id` INTEGER NOT NULL AUTO_INCREMENT,
   `username` VARCHAR(128) NOT NULL,
    `password` VARCHAR(128) NOT NULL,
    `email` VARCHAR(128) NOT NULL,
    `profile` VARCHAR(128) NOT NULL,
    `phno` VARCHAR(10) NOT NULL,
    `createdate` DATE NOT NULL,
    `lastmodified` DATE,
    `fname` VARCHAR(128) NOT NULL,
    `lname` VARCHAR(128) NOT NULL,
     PRIMARY KEY( `user_id` ),
     CONSTRAINT FK_profile FOREIGN KEY(`profile`)
	REFERENCES `tbl_profileref` (`key`)
) ENGINE = InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbl_application` (
   `app_id` INTEGER NOT NULL AUTO_INCREMENT,
   `name` VARCHAR(128) NOT NULL,
   `code` VARCHAR(128) NOT NULL,
   `summary` VARCHAR(128) NOT NULL,
   `category` VARCHAR(128) NOT NULL,
   `rating` DECIMAL(10,2),
   `ndownloads` INTEGER NOT NULL,
   `logo` VARCHAR(128) NOT NULL,
   `platform` VARCHAR(128) NOT NULL,
   `device` VARCHAR(128) NOT NULL,
    PRIMARY KEY( `app_id` ),
    CONSTRAINT FK_category FOREIGN KEY ( `category` )
	REFERENCES `tbl_category` ( `key` ) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE = InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbl_appstatus` (
   `id` INTEGER NOT NULL AUTO_INCREMENT,
   `app_id` INTEGER NOT NULL,
   `reviewer_id` INTEGER NOT NULL,
   `createdate` DATE NOT NULL,
   `lastmodified` DATE,
   `activity` VARCHAR(300) NOT NULL,
   `version` VARCHAR(10) NOT NULL,
   `approvestatus` VARCHAR(10) NOT NULL,
   `size` VARCHAR(128) NOT NULL,
   `code` VARCHAR(128) NOT NULL,
   `comment` VARCHAR(500) NOT NULL,
    PRIMARY KEY( `id` ),
    CONSTRAINT FK_key FOREIGN KEY( `approvestatus` )
	REFERENCES `tbl_approval_ref` ( `key` ) ON DELETE CASCADE ON UPDATE CASCADE,

    CONSTRAINT FK_appid FOREIGN KEY(`app_id`)
	REFERENCES `tbl_application` ( `app_id` ) ON DELETE CASCADE ON UPDATE CASCADE,

    CONSTRAINT FK_reviewer FOREIGN KEY (`reviewer_id` ) 
	REFERENCES `tbl_user` ( `user_id` ) ON DELETE CASCADE ON UPDATE CASCADE
   
)ENGINE = InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `tbl_apprating` (
    `id` INTEGER NOT NULL  AUTO_INCREMENT,
    `app_id` INTEGER NOT NULL,
    `user_id` INTEGER NOT NULL,
    `rating` INTEGER NOT NULL,
    `date` DATE NOT NULL,
     PRIMARY KEY( `id` ),
     CONSTRAINT FK_appid FOREIGN KEY(`app_id`)
	REFERENCES `tbl_application` ( `app_id` ) ON DELETE CASCADE ON UPDATE CASCADE,
     CHECK ( `rating` < 5 )
)ENGINE = InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbl_screenshot` (
   `id` INTEGER NOT NULL AUTO_INCREMENT,
   `app_id` INTEGER NOT NULL,
   `screenshot` VARCHAR(128) NOT NULL,
    PRIMARY KEY( `id` ),
    CONSTRAINT FK_app_id FOREIGN KEY( `app_id` ) 
	REFERENCES `tbl_application` ( `app_id` ) ON DELETE ON UPDATE CASCADE
)ENGINE = InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbl_appreview` ( 
   `id` INTEGER NOT NULL AUTO_INCREMENT,
   `app_id` INTEGER NOT NULL,
   `user_id` INTEGER NOT NULL,
   `review` VARCHAR(128) NOT NULL,
   `date` DATE NOT NULL,
    PRIMARY KEY( `id` ),
    CONSTRAINT FK_appid2 FOREIGN KEY ( `app_id` )
	REFERENCES `tbl_application` ( `app_id` ) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT FK_user FOREIGN KEY ( `user_id` )
	REFERENCES tbl_user( `user_id` ) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE = InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbl_category`(
    `key` VARCHAR(10) NOT NULL,
    `category` VARCHAR(128) NOT NULL,
    PRIMARY KEY(`key`)
)ENGINE = InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbl_checklist` (
   `id` INTEGER NOT NULL PRIMARY KEY AUTO_INCREMENT,
   `categorykey` VARCHAR(10) NOT NULL,
   `field` VARCHAR(200) NOT NULL,
   CONSTRAINT FK_catkey FOREIGN KEY ( `categorykey` )
	REFERENCES tbl_category(`key`) ON DELETE CASCADE ON UPDATE CASCADE
)ENGINE = InnoDB DEFAULT CHARSET=utf8;
CREATE TABLE `tbl_cat_rev` ( 
   `id` INTEGER PRIMARY KEY AUTO_INCREMENT NOT NULL,
   `cat_key` VARCHAR(10) NOT NULL,
   `rev_id` INTEGER NOT NULL,
   CONSTRAINT FK_cat1 FOREIGN KEY ( `cat_key` ) 
	REFERENCES `tbl_category` (`key` )	 ON DELETE CASCADE ON UPDATE CASCADE
   CONSTRAINT FK_rev1 FOREIGN KEY ( `rev_id` )	
	REFERENCES tbl_user ( `user_id` ) ON DELETE CASCADE ON UPDATE CASCADE
 )ENGINE = InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `tbl_approval_ref` (
    `key` VARCHAR (10) PRIMARY KEY NOT NULL ,
    `status` VARCHAR (100) NOT NULL,
)ENGINE = InnoDB DEFAULT CHARSET=utf8;
